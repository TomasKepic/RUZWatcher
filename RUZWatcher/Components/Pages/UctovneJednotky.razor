@page "/uctovnejednotky"
@using RUZWatcher.Models
@using RUZWatcher.Services
@using Microsoft.JSInterop
@inject ExcelExportService ExcelService
@inject IJSRuntime JS

@rendermode InteractiveServer

@inject DbService UctovnaService
@inject NotificationService NotificationService

<h2 class="mb-4 text-xl font-semibold">Účtovné jednotky</h2>

@if (jednotky == null)
{
    <p>Načítavam údaje...</p>
}
else if (jednotky.Count == 0)
{
    <p>V databáze sa nenachádzajú žiadne účtovné jednotky.</p>
}
else
{
    <RadzenFieldset AllowCollapse="true">
        <HeaderTemplate>
            <b>Sledovaní účtovné jednotky v našej databáze</b>
        </HeaderTemplate>
        <ChildContent>
            <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterMode="FilterMode.Simple" AllowPaging="true" PageSize="15"
                            AllowSorting="true" AllowColumnReorder="true" Data="@jednotky" TItem="Models.UctovnaJednotka" ExpandMode="DataGridExpandMode.Single" AndOperatorText="A" ApplyFilterText="Použiť filter" ClearFilterText="Zrušiť filter" EmptyText="(prázdne)" EndsWithText="Končí na" EqualsText="Rovná sa" GreaterThanOrEqualsText="Väčšie alebo rovné ako" GreaterThanText="Väčšie ako" LessThanOrEqualsText="Menšie alebo rovné ako" LessThanText="Menšie ako" NotEqualsText="Nerovná sa" OrOperatorText="Alebo" StartsWithText="Začína na" ColumnWidth="auto" ContainsText="Obsahuje">
                <Columns>
                    <RadzenDataGridColumn Property="Id" Title="Id" />
                    <RadzenDataGridColumn Property="NazovSubjektu" Title="Nazov" />
                    <RadzenDataGridColumn Property="PravnaForma" Title="Právna forma" />
                    <RadzenDataGridColumn Property="AdresaMesto" Title="AdresaMesto" />
                    <RadzenDataGridColumn Property="DatumVzniku" Title="Dátum vzniku" FormatString="{0:dd.MM.yyyy}" />
                    <RadzenDataGridColumn Property="Poznámka" Title="Poznámka" />
                    <RadzenDataGridColumn Property="Hodnotenie" Title="Hodnotenie" TextAlign="TextAlign.Center">
                        <Template Context="data">
                            <RadzenRating @bind-Value=@(data.Hodnotenie) Name="hodnotenie"></RadzenRating>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="Id" Title="Vymazať">
                        <Template Context="data">
                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Text="Zmazať" Click="@(() => DeleteJednotka(data.Id!.Value))" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </ChildContent>
    </RadzenFieldset>
    <br />
    <RadzenButton Icon="file_download" Text="Export do Excelu" Click="@ExportToExcel" Disabled="@(!jednotky.Any())" ButtonStyle="ButtonStyle.Success" />
}

@code {
    private List<UctovnaJednotka>? jednotky;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        jednotky = await UctovnaService.GetAllJednotkyAsync();
    }

    private async Task DeleteJednotka(long id)
    {
        await UctovnaService.DeleteJednotkaAsync(id);
        await LoadData();
    }

    void ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);
    }

    private async Task ExportToExcel()
    {
        try
        {
            if (jednotky != null)
            {
                // Generuj Excel súbor
                var excelData = ExcelService.ExportUctovneJednotky(jednotky);
                var fileName = ExcelService.GetFileName();

                // Stiahni súbor v prehliadači
                await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(excelData));
            }
        }
        catch (Exception ex)
        {
            // Notifikácia o prípadne neúspešnom exporte cez Radzen NotificationService
            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Chyba pri exporte do excelu.", Detail = $"{ex.Message}", Duration = 4000 });
        }
    }
}
